/**
 * ğŸ“Š TABLE TESTS - T10 Implementation
 * Testes especÃ­ficos para funcionalidades de tabela implementadas em T9
 * ValidaÃ§Ã£o de paginaÃ§Ã£o, filtros, busca e interaÃ§Ãµes
 */

import { test, expect } from '@playwright/test';

test.describe('Testes de Tabela - DataTable Component', () => {
  
  test.beforeEach(async ({ page }) => {
    await page.goto('/tables-demo');
    await page.waitForSelector('table', { timeout: 10000 });
  });
  
  test('deve exibir dados na tabela bÃ¡sica', async ({ page }) => {
    // Verifica se a tabela tem dados
    const rows = page.locator('tbody tr');
    await expect(rows).toHaveCountGreaterThan(0);
    
    // Verifica se as colunas estÃ£o presentes
    await expect(page.locator('th:has-text("ID")')).toBeVisible();
    await expect(page.locator('th:has-text("Produto")')).toBeVisible();
    await expect(page.locator('th:has-text("Categoria")')).toBeVisible();
    await expect(page.locator('th:has-text("PreÃ§o")')).toBeVisible();
    await expect(page.locator('th:has-text("Estoque")')).toBeVisible();
  });
  
  test('deve funcionar a busca global', async ({ page }) => {
    // Localiza o campo de busca
    const searchInput = page.locator('input[placeholder*="Buscar"]').first();
    
    // Testa busca por produto especÃ­fico
    await searchInput.fill('Smartphone');
    await page.waitForTimeout(500); // Aguarda debounce
    
    // Verifica se filtrou corretamente
    const visibleRows = page.locator('tbody tr:visible');
    await expect(visibleRows).toHaveCount(1);
    await expect(page.locator('text=Smartphone Pro Max')).toBeVisible();
    
    // Limpa a busca
    await searchInput.clear();
    await page.waitForTimeout(500);
    
    // Verifica se voltou a mostrar todos os itens
    await expect(visibleRows).toHaveCountGreaterThan(1);
  });
  
  test('deve funcionar os filtros por coluna', async ({ page }) => {
    // Abre o painel de filtros
    const filterButton = page.locator('button:has-text("Filtros")');
    await filterButton.click();
    
    // Verifica se o painel de filtros abriu
    await expect(page.locator('text=Filtrar por categoria')).toBeVisible();
    
    // Aplica um filtro por categoria
    const categoryFilter = page.locator('input[placeholder*="categoria"]');
    await categoryFilter.fill('Electronics');
    
    // Aplica os filtros
    await page.locator('button:has-text("Aplicar Filtros")').click();
    
    // Verifica se filtrou corretamente
    await page.waitForTimeout(500);
    const filteredRows = page.locator('tbody tr:visible');
    await expect(filteredRows).toHaveCountGreaterThan(0);
    
    // Verifica se todos os itens visÃ­veis sÃ£o da categoria Electronics
    const categoryBadges = page.locator('tbody tr:visible .bg-blue-100');
    const badgeCount = await categoryBadges.count();
    expect(badgeCount).toBeGreaterThan(0);
  });
  
  test('deve funcionar a ordenaÃ§Ã£o por colunas', async ({ page }) => {
    // Clica no header da coluna de preÃ§o para ordenar
    const priceHeader = page.locator('th:has-text("PreÃ§o") button');
    await priceHeader.click();
    
    // Aguarda a ordenaÃ§Ã£o
    await page.waitForTimeout(500);
    
    // Verifica se o Ã­cone de ordenaÃ§Ã£o apareceu
    const sortIcon = page.locator('th:has-text("PreÃ§o") span');
    await expect(sortIcon).toBeVisible();
    
    // Clica novamente para inverter a ordenaÃ§Ã£o
    await priceHeader.click();
    await page.waitForTimeout(500);
    
    // Verifica se a ordenaÃ§Ã£o mudou
    await expect(sortIcon).toBeVisible();
  });
  
  test('deve funcionar a paginaÃ§Ã£o', async ({ page }) => {
    // Verifica se os controles de paginaÃ§Ã£o estÃ£o presentes
    await expect(page.locator('text=PÃ¡gina')).toBeVisible();
    await expect(page.locator('text=Mostrar:')).toBeVisible();
    
    // Muda o nÃºmero de itens por pÃ¡gina
    const pageSizeSelect = page.locator('select').first();
    await pageSizeSelect.selectOption('10');
    
    // Aguarda a atualizaÃ§Ã£o
    await page.waitForTimeout(500);
    
    // Verifica se a informaÃ§Ã£o de paginaÃ§Ã£o foi atualizada
    await expect(page.locator('text=10')).toBeVisible();
    
    // Testa navegaÃ§Ã£o entre pÃ¡ginas (se houver mais de uma pÃ¡gina)
    const nextButton = page.locator('button[aria-label="Next page"], button:has(svg)');
    if (await nextButton.isEnabled()) {
      await nextButton.click();
      await page.waitForTimeout(500);
      
      // Verifica se mudou de pÃ¡gina
      await expect(page.locator('text=PÃ¡gina 2')).toBeVisible();
    }
  });
  
  test('deve funcionar a seleÃ§Ã£o de linhas', async ({ page }) => {
    // Verifica se hÃ¡ checkboxes de seleÃ§Ã£o
    const headerCheckbox = page.locator('thead input[type="checkbox"]');
    const rowCheckboxes = page.locator('tbody input[type="checkbox"]');
    
    if (await headerCheckbox.isVisible()) {
      // Seleciona todos os itens
      await headerCheckbox.click();
      
      // Verifica se todos os checkboxes foram marcados
      const checkedBoxes = page.locator('tbody input[type="checkbox"]:checked');
      const totalBoxes = await rowCheckboxes.count();
      const checkedCount = await checkedBoxes.count();
      
      expect(checkedCount).toBe(totalBoxes);
      
      // Verifica se apareceu a informaÃ§Ã£o de seleÃ§Ã£o
      await expect(page.locator('text=selecionado')).toBeVisible();
      
      // Desmarca todos
      await headerCheckbox.click();
      
      // Verifica se todos foram desmarcados
      const uncheckedCount = await page.locator('tbody input[type="checkbox"]:not(:checked)').count();
      expect(uncheckedCount).toBe(totalBoxes);
    }
  });
  
  test('deve funcionar as aÃ§Ãµes da tabela', async ({ page }) => {
    // Verifica se hÃ¡ botÃµes de aÃ§Ã£o
    const actionButtons = page.locator('tbody tr:first-child button');
    const actionCount = await actionButtons.count();
    
    if (actionCount > 0) {
      // Testa o primeiro botÃ£o de aÃ§Ã£o (geralmente "Ver")
      const firstAction = actionButtons.first();
      
      // Clica no botÃ£o e verifica se abre um alert ou modal
      page.on('dialog', dialog => {
        expect(dialog.message()).toContain('produto');
        dialog.accept();
      });
      
      await firstAction.click();
    }
  });
});

test.describe('Testes de Tabela - UsersTable Component', () => {
  
  test.beforeEach(async ({ page }) => {
    await page.goto('/tables-demo');
    
    // Muda para a aba UsersTable
    await page.locator('button:has-text("UsersTable")').click();
    await page.waitForTimeout(1000);
  });
  
  test('deve carregar a tabela de usuÃ¡rios', async ({ page }) => {
    // Aguarda a tabela carregar (pode demorar devido Ã  integraÃ§Ã£o com backend)
    await page.waitForSelector('table, text=Carregando, text=Erro', { timeout: 15000 });
    
    // Verifica se hÃ¡ conteÃºdo
    const hasTable = await page.locator('table').isVisible();
    const hasLoading = await page.locator('text=Carregando').isVisible();
    const hasError = await page.locator('text=Erro').isVisible();
    
    expect(hasTable || hasLoading || hasError).toBeTruthy();
    
    // Se a tabela carregou, verifica as colunas especÃ­ficas de usuÃ¡rios
    if (hasTable) {
      await expect(page.locator('th:has-text("Nome")')).toBeVisible();
      await expect(page.locator('th:has-text("Email")')).toBeVisible();
      await expect(page.locator('th:has-text("Role")')).toBeVisible();
      await expect(page.locator('th:has-text("Status")')).toBeVisible();
    }
  });
  
  test('deve exibir badges de role e status corretamente', async ({ page }) => {
    // Aguarda a tabela carregar
    const table = page.locator('table');
    await table.waitFor({ timeout: 15000 });
    
    if (await table.isVisible()) {
      // Verifica se hÃ¡ badges de role
      const roleBadges = page.locator('.bg-red-100, .bg-blue-100, .bg-purple-100, .bg-gray-100');
      if (await roleBadges.count() > 0) {
        await expect(roleBadges.first()).toBeVisible();
      }
      
      // Verifica se hÃ¡ badges de status
      const statusBadges = page.locator('.bg-green-100, .bg-yellow-100');
      if (await statusBadges.count() > 0) {
        await expect(statusBadges.first()).toBeVisible();
      }
    }
  });
  
  test('deve funcionar a busca de usuÃ¡rios', async ({ page }) => {
    // Aguarda a tabela carregar
    await page.waitForSelector('table, text=Carregando', { timeout: 15000 });
    
    const searchInput = page.locator('input[placeholder*="usuÃ¡rios"]');
    if (await searchInput.isVisible()) {
      // Testa a busca
      await searchInput.fill('admin');
      await page.waitForTimeout(1000);
      
      // Verifica se a busca foi aplicada (pode nÃ£o haver resultados)
      const rows = page.locator('tbody tr');
      const rowCount = await rows.count();
      
      // A busca deve ter sido executada (mesmo que nÃ£o haja resultados)
      expect(rowCount).toBeGreaterThanOrEqual(0);
    }
  });
  
  test('deve funcionar as aÃ§Ãµes especÃ­ficas de usuÃ¡rios', async ({ page }) => {
    // Aguarda a tabela carregar
    await page.waitForSelector('table, text=Carregando', { timeout: 15000 });
    
    const table = page.locator('table');
    if (await table.isVisible()) {
      // Verifica se hÃ¡ aÃ§Ãµes especÃ­ficas de usuÃ¡rios
      const userActions = page.locator('button:has-text("Ver"), button:has-text("Editar"), button:has-text("Promover")');
      const actionCount = await userActions.count();
      
      if (actionCount > 0) {
        // Testa uma aÃ§Ã£o (com handler de dialog)
        page.on('dialog', dialog => {
          expect(dialog.message()).toContain('usuÃ¡rio');
          dialog.accept();
        });
        
        await userActions.first().click();
      }
    }
  });
});

test.describe('Testes de Tabela - Funcionalidades AvanÃ§adas', () => {
  
  test.beforeEach(async ({ page }) => {
    await page.goto('/tables-demo');
    
    // Muda para a aba de funcionalidades avanÃ§adas
    await page.locator('button:has-text("Funcionalidades AvanÃ§adas")').click();
  });
  
  test('deve exibir informaÃ§Ãµes sobre as funcionalidades', async ({ page }) => {
    // Verifica se as informaÃ§Ãµes estÃ£o presentes
    await expect(page.locator('text=Funcionalidades Implementadas')).toBeVisible();
    await expect(page.locator('text=EstatÃ­sticas dos Componentes')).toBeVisible();
    await expect(page.locator('text=Exemplos de Uso')).toBeVisible();
    
    // Verifica se hÃ¡ checkmarks das funcionalidades
    const checkmarks = page.locator('span:has-text("âœ…")');
    await expect(checkmarks).toHaveCountGreaterThan(5);
  });
  
  test('deve exibir estatÃ­sticas corretas', async ({ page }) => {
    // Verifica se as estatÃ­sticas estÃ£o presentes
    await expect(page.locator('text=DataTable (Core)')).toBeVisible();
    await expect(page.locator('text=useDataTable Hook')).toBeVisible();
    await expect(page.locator('text=UsersTable')).toBeVisible();
    
    // Verifica se hÃ¡ nÃºmeros de linhas de cÃ³digo
    await expect(page.locator('text=linhas')).toBeVisible();
  });
  
  test('deve exibir exemplos de cÃ³digo', async ({ page }) => {
    // Verifica se hÃ¡ exemplos de cÃ³digo
    const codeBlock = page.locator('pre');
    await expect(codeBlock).toBeVisible();
    
    // Verifica se contÃ©m cÃ³digo TypeScript/JavaScript
    const codeText = await codeBlock.textContent();
    expect(codeText).toContain('DataTable');
    expect(codeText).toContain('useDataTable');
  });
});

test.describe('Testes de Tabela - Responsividade', () => {
  
  test('deve ser responsiva em dispositivos mÃ³veis', async ({ page }) => {
    // Simula um dispositivo mÃ³vel
    await page.setViewportSize({ width: 375, height: 667 });
    
    await page.goto('/tables-demo');
    await page.waitForSelector('table', { timeout: 10000 });
    
    // Verifica se a tabela se adapta ao mobile
    const table = page.locator('table');
    const tableContainer = page.locator('.overflow-x-auto');
    
    await expect(table).toBeVisible();
    await expect(tableContainer).toBeVisible();
    
    // Verifica se os controles de paginaÃ§Ã£o sÃ£o responsivos
    const paginationControls = page.locator('text=Mostrar:');
    if (await paginationControls.isVisible()) {
      const controlsBox = await paginationControls.boundingBox();
      expect(controlsBox?.width).toBeLessThanOrEqual(375);
    }
  });
  
  test('deve funcionar em tablets', async ({ page }) => {
    // Simula um tablet
    await page.setViewportSize({ width: 768, height: 1024 });
    
    await page.goto('/tables-demo');
    await page.waitForSelector('table', { timeout: 10000 });
    
    // Verifica se a tabela funciona bem em tablets
    const table = page.locator('table');
    await expect(table).toBeVisible();
    
    // Verifica se as abas sÃ£o clicÃ¡veis
    const tabs = page.locator('button:has-text("DataTable BÃ¡sico")');
    await expect(tabs).toBeVisible();
    await tabs.click();
    
    // Verifica se a navegaÃ§Ã£o funciona
    await expect(page.locator('table')).toBeVisible();
  });
});